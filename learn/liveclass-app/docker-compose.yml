version: '3.8'

services:
  # ===========================================
  # LiveClass Application
  # ===========================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: liveclass-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8080}:8080"
    environment:
      # Server
      - HOST=0.0.0.0
      - PORT=8080
      - INSTANCE_ID=${HOSTNAME:-app-1}
      
      # MongoDB
      - MONGO_URI=mongodb://mongodb:27017
      - MONGO_DB_NAME=${MONGO_DB_NAME:-liveclass}
      - MONGO_MAX_POOL_SIZE=${MONGO_MAX_POOL_SIZE:-100}
      - MONGO_MIN_POOL_SIZE=${MONGO_MIN_POOL_SIZE:-10}
      
      # Redis (enable for multi-instance)
      - REDIS_ENABLED=${REDIS_ENABLED:-false}
      - REDIS_URL=redis://redis:6379
      
      # JWT (CHANGE IN PRODUCTION!)
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      - JWT_EXPIRY_HOURS=${JWT_EXPIRY_HOURS:-72}
      
      # Admin credentials (first run only)
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@liveclass.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - ADMIN_NAME=${ADMIN_NAME:-Administrator}
      
      # Cache settings
      - CACHE_ENABLED=${CACHE_ENABLED:-true}
      - USER_CACHE_TTL_SEC=${USER_CACHE_TTL_SEC:-300}
      - BATCH_CACHE_TTL_SEC=${BATCH_CACHE_TTL_SEC:-60}
      
      # Performance
      - ENABLE_COMPRESSION=${ENABLE_COMPRESSION:-true}
      - REQUEST_TIMEOUT_SEC=${REQUEST_TIMEOUT_SEC:-15}
      - SHUTDOWN_TIMEOUT_SEC=${SHUTDOWN_TIMEOUT_SEC:-30}
      
      # Storage
      - STORAGE_PATH=/app/storage
    volumes:
      - liveclass-storage:/app/storage
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - liveclass-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================
  # MongoDB Database
  # ===========================================
  mongodb:
    image: mongo:7.0
    container_name: liveclass-mongodb
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"
    environment:
      - MONGO_INITDB_DATABASE=${MONGO_DB_NAME:-liveclass}
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    networks:
      - liveclass-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    command: ["mongod", "--quiet", "--logpath", "/dev/null"]

  # ===========================================
  # Redis (for multi-instance mode)
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: liveclass-redis
    restart: unless-stopped
    profiles:
      - multi
      - dev
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    networks:
      - liveclass-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: ["redis-server", "--appendonly", "yes", "--maxmemory", "256mb", "--maxmemory-policy", "allkeys-lru"]

  # ===========================================
  # MongoDB Express (Optional - Dev Only)
  # ===========================================
  mongo-express:
    image: mongo-express:latest
    container_name: liveclass-mongo-express
    restart: unless-stopped
    profiles:
      - dev
    ports:
      - "${MONGO_EXPRESS_PORT:-8081}:8081"
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongodb
      - ME_CONFIG_MONGODB_PORT=27017
      - ME_CONFIG_BASICAUTH_USERNAME=${MONGO_EXPRESS_USER:-admin}
      - ME_CONFIG_BASICAUTH_PASSWORD=${MONGO_EXPRESS_PASS:-admin123}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - liveclass-network

# ===========================================
# Volumes
# ===========================================
volumes:
  mongodb-data:
    name: liveclass-mongodb-data
  mongodb-config:
    name: liveclass-mongodb-config
  redis-data:
    name: liveclass-redis-data
  liveclass-storage:
    name: liveclass-storage

# ===========================================
# Networks
# ===========================================
networks:
  liveclass-network:
    name: liveclass-network
    driver: bridge
